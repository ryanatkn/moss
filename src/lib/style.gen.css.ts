import type {Gen} from '@ryanatkn/gro';
import {readFile} from 'node:fs/promises';

// TODO BLOCK ensure this works with the watcher
// TODO BLOCK Module import ./src/lib/style.gen.css.ts failed from input ./src/lib/style.gen.css.ts: Error: ENOENT: no such file or directory, open '/home/desk/dev/moss/src/lib/src/lib/style_reset.css.ts'
// TODO BLOCK needs to handle ?raw in the watcher (just strip anything after `?`?)
import style_reset from './src/lib/style_reset.css?raw';
import style_components from './src/lib/style_components.css?raw';
import style_animations from './src/lib/style_animations.css?raw';

/**
 * Concatenates the `.css` files into `style.css` as a convenience.
 */
export const gen: Gen = async ({origin_path}) => {
	const banner = `/* generated by ${origin_path} */`;

	// The style utilities override everything else, so they go last,
	// and some selectors in previous files may need to lower specificity with `:where`.

	const sheets = await Promise.all([
		concat_stylesheet('./src/lib/style_reset.css', style_reset),

		concat_stylesheet('./src/lib/style_components.css', style_components),

		concat_stylesheet('./src/lib/style_animations.css', style_animations),
	]);

	return `${banner}

${sheets.join('\n\n')}

    ${banner}
  `;
};

const concat_stylesheet = async (path: string, text: string): Promise<string> => {
	const contents = await readFile(path, 'utf8');

	return `
/* @source ${path} */

${contents}

/* end ${path} */\n\n`;
};
